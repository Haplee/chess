<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Juego de Ajedrez 1vs1 Mejorado</title>
  <!-- Tablero visual -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.css" />
  <style>
    body { background: #222; color: #fff; font-family: Arial, sans-serif; margin:0; padding:0; display:flex; flex-direction:column; align-items:center; }
    #board { width: 480px; margin: 20px; }
    #controls { display:flex; gap:10px; align-items:center; }
    button { padding:8px 12px; border:none; border-radius:4px; cursor:pointer; }
    #moves { max-height:200px; overflow:auto; width:480px; background:#333; padding:10px; border-radius:4px; }
  </style>
</head>
<body>
  <div id="controls">
    <div id="turn">Turno: Blancas</div>
    <button id="offerDraw">Ofrecer Tablas</button>
    <button id="resign">Rendirse</button>
  </div>
  <div id="board"></div>
  <div id="timers">
    <span id="whiteClock">Blancas: 10:00</span> –
    <span id="blackClock">Negras: 10:00</span>
  </div>
  <div id="moves"></div>

  <script type="module">
    import { Chess } from 'https://cdn.jsdelivr.net/npm/chess.js@1.2.0/esm/chess.js';  // Lógica completa: movimientos, jaque, mate, tablas, en passant, promoción, enroque :contentReference[oaicite:0]{index=0}
    import Chessboard from 'https://cdn.jsdelivr.net/npm/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js';

    const chess = new Chess();                                      // Estado del juego
    const board = Chessboard('board', { position: 'start', draggable: true, onDrop: handleMove });

    // Temporizadores (10 min inicial, control de reloj FIDE) :contentReference[oaicite:1]{index=1}
    let clocks = { white: 600, black: 600 }, timers = {};
    function startClock(color) {
      clearInterval(timers.white); clearInterval(timers.black);
      timers[color] = setInterval(() => {
        clocks[color]--; updateClocks();
        if (clocks[color] <= 0) { gameOver(`${color==='white'?'Blancas':'Negras'} pierde por tiempo`); }
      }, 1000);
    }
    function updateClocks() {
      ['white','black'].forEach(c=>{
        let m=Math.floor(clocks[c]/60), s=clocks[c]%60;
        document.getElementById(c+'Clock').textContent = `${c==='white'?'Blancas':'Negras'}: ${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
      });
    }
    startClock('white');

    // Registro de movimientos (notación algebraica) :contentReference[oaicite:2]{index=2}
    function refreshMoves() {
      const history = chess.history({ verbose: true });
      document.getElementById('moves').innerHTML = history.map((m,i) => 
        (i%2===0?`${Math.floor(i/2)+1}. `:'') + m.san
      ).join(' ');
    }

    // Gestión del turno y UI
    function updateTurn() {
      document.getElementById('turn').textContent = 'Turno: ' + (chess.turn()==='w'?'Blancas':'Negras');
      startClock(chess.turn()==='w'?'white':'black');
    }

    // Comprueba fin de partida: jaque mate, tablas por 50 movimientos, repetición o material insuficiente :contentReference[oaicite:3]{index=3} :contentReference[oaicite:4]{index=4} :contentReference[oaicite:5]{index=5}
    function handleEnd() {
      if (chess.isCheckmate()) gameOver('¡Jaque mate! ' + (chess.turn()==='w'?'Negras':'Blancas') + ' gana');
      else if (chess.isStalemate()) gameOver('Tablas por ahogado');                           // Art. 5.2.1 :contentReference[oaicite:6]{index=6}
      else if (chess.isInsufficientMaterial()) gameOver('Tablas por material insuficiente');   // Art. 5.2.2 :contentReference[oaicite:7]{index=7}
      else if (chess.isThreefoldRepetition()) gameOver('Tablas por tres repeticiones');        // Art. 9.2 :contentReference[oaicite:8]{index=8}
      else if (chess.isDraw()) gameOver('Tablas (regla 50 movimientos)');                      // Art. 9.3 :contentReference[oaicite:9]{index=9}
    }

    // Mueve la pieza usando chess.js (valida enroque Art.3.8 :contentReference[oaicite:10]{index=10}, en passant Art.3.7.4 :contentReference[oaicite:11]{index=11}, promoción Art.3.7.5 :contentReference[oaicite:12]{index=12})
    function handleMove(source, target, piece) {
      const move = chess.move({ from: source, to: target, promotion: 'q' });
      if (move) {
        board.position(chess.fen());
        refreshMoves();
        updateTurn();
        handleEnd();
        return true;
      }
      return 'snapback';
    }

    // Ofrecer tablas (claim) :contentReference[oaicite:13]{index=13}
    document.getElementById('offerDraw').onclick = () => {
      if (chess.canClaimThreefoldRepetition()) gameOver('Tablas reclamadas por repetición');
      else if (chess.canClaimFiftyMoves()) gameOver('Tablas reclamadas por regla de 50 movimientos');
      else alert('No se cumplen condiciones de tablas'); 
    };

    // Rendición
    document.getElementById('resign').onclick = () => gameOver((chess.turn()==='w'?'Blancas':'Negras') + ' se rinden');

    function gameOver(message) {
      clearInterval(timers.white); clearInterval(timers.black);
      alert(message);
    }
  </script>
</body>
</html>
